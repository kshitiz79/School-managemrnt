{
    "sourceFile": "src/pages/communication/TemplateEmail.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1755985893077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755986649572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,5 @@\n import React, { useState } from 'react'\n-import { useState } from 'react'\n import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'\n import { communicationApi } from '../../lib/api/communication'\n import Button from '../../components/Button'\n \n"
                },
                {
                    "date": 1755987434760,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -203,17 +203,18 @@\n       ...new Set([\n         ...extractVariables(template.subject),\n         ...extractVariables(template.content),\n       ]),\n+    ];\n \n     setFormData(prev => ({\n       ...prev,\n       name: template.name,\n       subject: template.subject,\n       content: template.content,\n       category: template.category,\n       variables: allVariables,\n-    }))\n+    }));\n   };\n \n   return (\n     <div className=\"p-6\">\n"
                }
            ],
            "date": 1755985893077,
            "name": "Commit-0",
            "content": "import React, { useState } from 'react'\nimport { useState } from 'react'\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'\nimport { communicationApi } from '../../lib/api/communication'\nimport Button from '../../components/Button'\n\nconst TemplateEmail = () => {\n  const [formData, setFormData] = useState({\n    name: '',\n    subject: '',\n    content: '',\n    category: 'general',\n    variables: [],\n    isActive: true,\n    isHtml: false,\n  })\n  const [editingId, setEditingId] = useState(null)\n  const [previewData, setPreviewData] = useState({})\n\n  const queryClient = useQueryClient()\n\n  const { data: templates = [], isLoading } = useQuery({\n    queryKey: ['templates', 'email'],\n    queryFn: () => communicationApi.getTemplates('email'),\n  })\n\n  const addTemplateMutation = useMutation({\n    mutationFn: data => communicationApi.addTemplate('email', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries(['templates', 'email'])\n      resetForm()\n      alert('Email template added successfully!')\n    }\n  })\n\n  const updateTemplateMutation = useMutation({\n    mutationFn: ({ id, data }) =>\n      communicationApi.updateTemplate('email', id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries(['templates', 'email'])\n      resetForm()\n      alert('Email template updated successfully!')\n    }\n  })\n\n  const deleteTemplateMutation = useMutation({\n    mutationFn: id => communicationApi.deleteTemplate('email', id),\n    onSuccess: () => {\n      queryClient.invalidateQueries(['templates', 'email'])\n      alert('Email template deleted successfully!')\n    }\n  })\n\n  const resetForm = () => {\n    setFormData({\n      name: '',\n      subject: '',\n      content: '',\n      category: 'general',\n      variables: [],\n      isActive: true,\n      isHtml: false,\n    })\n    setEditingId(null)\n    setPreviewData({})\n  };\n\n  const handleSubmit = e => {\n    e.preventDefault()\n    if (editingId) {\n      updateTemplateMutation.mutate({ id: editingId, data: formData })\n    } else {\n      addTemplateMutation.mutate(formData)\n    }\n  }\n\n  const handleEdit = template => {\n    setFormData({\n      name: template.name,\n      subject: template.subject || '',\n      content: template.content,\n      category: template.category,\n      variables: template.variables || [],\n      isActive: template.isActive,\n      isHtml: template.isHtml || false,\n    })\n    setEditingId(template.id)\n  };\n\n  const handleDelete = id => {\n    if (window.confirm('Are you sure you want to delete this template?')) {\n      deleteTemplateMutation.mutate(id)\n    }\n  }\n\n  const extractVariables = text => {\n    const matches = text.match(/\\{\\{([^}]+)\\}\\}/g)\n    return matches ? matches.map(match => match.replace(/[{}]/g, '')) : []\n  };\n\n  const handleContentChange = content => {\n    const subjectVars = extractVariables(formData.subject)\n    const contentVars = extractVariables(content)\n    const allVariables = [...new Set([...subjectVars, ...contentVars])]\n    setFormData(prev => ({ ...prev, content, variables: allVariables }))\n  };\n\n  const handleSubjectChange = subject => {\n    const subjectVars = extractVariables(subject)\n    const contentVars = extractVariables(formData.content)\n    const allVariables = [...new Set([...subjectVars, ...contentVars])]\n    setFormData(prev => ({ ...prev, subject, variables: allVariables }))\n  };\n\n  const generatePreview = (template, field) => {\n    let preview = template[field] || ''\n    template.variables?.forEach(variable => {\n      const value = previewData[variable] || `[${variable}]`\n      preview = preview.replace(\n        new RegExp(`\\\\{\\\\{${variable}\\\\}\\\\}`, 'g'),\n        value\n      )\n    })\n    return preview\n  };\n\n  const predefinedTemplates = [\n    {\n      name: 'Fee Payment Reminder',\n      subject: 'Fee Payment Reminder - {{student_name}} ({{class}})',\n      content: `Dear {{parent_name}},\n\nThis is a friendly reminder that the fee payment for {{student_name}} studying in Class {{class}} is due.\n\nPayment Details:\n- Amount: â‚¹{{amount}}\n- Due Date: {{due_date}}\n- Late Fee: â‚¹{{late_fee}} (applicable after due date)\n\nPlease make the payment at your earliest convenience to avoid any inconvenience.\n\nYou can pay online through our school portal or visit the school office during working hours.\n\nThank you for your cooperation.\n\nBest regards,\n{{school_name}}\nFinance Department`,\n      category: 'fees',\n    },\n    {\n      name: 'Exam Schedule Notification',\n      subject: '{{exam_name}} Schedule - {{student_name}} ({{class}})',\n      content: `Dear {{parent_name}},\n\nWe are pleased to inform you about the upcoming {{exam_name}} for your ward {{student_name}} studying in Class {{class}}.\n\nExam Schedule:\n- Start Date: {{start_date}}\n- End Date: {{end_date}}\n- Reporting Time: {{reporting_time}}\n- Venue: {{venue}}\n\nPlease ensure that {{student_name}} is well-prepared and reaches school on time for all examinations.\n\nAdmit cards will be distributed shortly. Please contact the school office if you have any queries.\n\nBest wishes for the examinations!\n\nRegards,\n{{school_name}}\nAcademic Department`,\n      category: 'exams',\n    },\n    {\n      name: 'Event Invitation',\n      subject: 'Invitation: {{event_name}} - {{date}}',\n      content: `Dear {{parent_name}},\n\nWe are delighted to invite you and your family to our upcoming event:\n\nEvent Details:\n- Event: {{event_name}}\n- Date: {{date}}\n- Time: {{time}}\n- Venue: {{venue}}\n- Dress Code: {{dress_code}}\n\nThis event promises to be an enriching experience for students and parents alike. Your presence would make the occasion more memorable.\n\nPlease confirm your attendance by {{rsvp_date}}.\n\nLooking forward to seeing you there!\n\nWarm regards,\n{{school_name}}\nEvent Committee`,\n      category: 'events',\n    }\n  ]\n\n  const loadPredefinedTemplate = template => {\n    const allVariables = [\n      ...new Set([\n        ...extractVariables(template.subject),\n        ...extractVariables(template.content),\n      ]),\n\n    setFormData(prev => ({\n      ...prev,\n      name: template.name,\n      subject: template.subject,\n      content: template.content,\n      category: template.category,\n      variables: allVariables,\n    }))\n  };\n\n  return (\n    <div className=\"p-6\">\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h2 className=\"text-2xl font-bold mb-6\">ðŸ“§ Email Templates</h2>\n\n        {/* Quick Templates */}\n        <div className=\"bg-blue-50 p-4 rounded-md mb-6\">\n          <h3 className=\"text-lg font-semibold mb-3\">Quick Templates</h3>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2\">\n            {Array.isArray(predefinedTemplates) &&\n              predefinedTemplates.map((template, index) => (\n                <Button\n                  key={index}\n                  onClick={() => loadPredefinedTemplate(template)}\n                  className=\"bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700\"\n                >\n                  {template.name}\n                </Button>\n              ))}\n          </div>\n        </div>\n\n        {/* Add/Edit Form */}\n        <div className=\"bg-gray-50 p-4 rounded-md mb-6\">\n          <h3 className=\"text-lg font-semibold mb-4\">\n            {editingId ? 'Edit Template' : 'Add New Template'}\n          </h3>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Template Name *\n                </label>\n                <input\n                  type=\"text\"\n                  value={formData.name}\n                  onChange={e =>\n                    setFormData(prev => ({ ...prev, name: e.target.value }))\n                  }\n                  className=\"w-full p-2 border rounded-md\"\n                  required\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Category\n                </label>\n                <select\n                  value={formData.category}\n                  onChange={e =>\n                    setFormData(prev => ({ ...prev, category: e.target.value }))\n                  }\n                  className=\"w-full p-2 border rounded-md\"\n                >\n                  <option value=\"general\">General</option>\n                  <option value=\"fees\">Fees</option>\n                  <option value=\"attendance\">Attendance</option>\n                  <option value=\"exams\">Exams</option>\n                  <option value=\"events\">Events</option>\n                  <option value=\"announcements\">Announcements</option>\n                  <option value=\"results\">Results</option>\n                </select>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium mb-2\">\n                Email Subject *\n              </label>\n              <input\n                type=\"text\"\n                value={formData.subject}\n                onChange={e => handleSubjectChange(e.target.value)}\n                className=\"w-full p-2 border rounded-md\"\n                required\n                placeholder=\"Enter email subject line\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium mb-2\">\n                Email Content *\n              </label>\n              <div className=\"flex items-center mb-2\">\n                <input\n                  type=\"checkbox\"\n                  id=\"isHtml\"\n                  checked={formData.isHtml}\n                  onChange={e =>\n                    setFormData(prev => ({ ...prev, isHtml: e.target.checked }))\n                  }\n                  className=\"mr-2\"\n                />\n                <label htmlFor=\"isHtml\" className=\"text-sm\">\n                  HTML Format\n                </label>\n              </div>\n              <textarea\n                value={formData.content}\n                onChange={e => handleContentChange(e.target.value)}\n                className=\"w-full p-2 border rounded-md font-mono\"\n                rows=\"12\"\n                required\n                placeholder={\n                  formData.isHtml\n                    ? 'Enter your HTML email content. Use {{variable_name}} for dynamic content.'\n                    : 'Enter your email content. Use {{variable_name}} for dynamic content.'\n                }\n              />\n              <div className=\"text-xs text-gray-600 mt-1\">\n                Use double curly braces for variables:\n                <span className=\"bg-gray-200 px-1 rounded\">\n                  {'{student_name}'}\n                </span>\n                ,\n                <span className=\"bg-gray-200 px-1 rounded\">\n                  {'{parent_name}'}\n                </span>\n                ,<span className=\"bg-gray-200 px-1 rounded\">{'{amount}'}</span>,\n                etc.\n              </div>\n            </div>\n\n            {/* Variables Display */}\n            {formData.variables.length > 0 && (\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Detected Variables\n                </label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {Array.isArray(formData.variables) &&\n                    formData.variables.map((variable, index) => (\n                      <span\n                        key={index}\n                        className=\"bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono\"\n                      >\n                        {`{${variable}}`}\n                      </span>\n                    ))}\n                </div>\n              </div>\n            )}\n\n            {/* Preview Section */}\n            {(formData.subject || formData.content) && (\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Preview\n                </label>\n                <div className=\"bg-white border rounded-md\">\n                  <div className=\"bg-blue-500 text-white p-2 rounded-t text-sm font-medium\">\n                    Email Preview\n                  </div>\n                  <div className=\"p-4 border-l border-r border-b rounded-b\">\n                    {formData.variables.length > 0 && (\n                      <div className=\"mb-4 p-3 bg-gray-50 rounded\">\n                        <div className=\"text-xs text-gray-600 mb-2\">\n                          Fill sample data for preview:\n                        </div>\n                        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\n                          {Array.isArray(formData.variables) &&\n                            formData.variables.map((variable, index) => (\n                              <input\n                                key={index}\n                                type=\"text\"\n                                placeholder={variable}\n                                value={previewData[variable] || ''}\n                                onChange={e =>\n                                  setPreviewData(prev => ({\n                                    ...prev,\n                                    [variable]: e.target.value,\n                                  }))\n                                }\n                                className=\"text-xs p-1 border rounded\"\n                              />\n                            ))}\n                        </div>\n                      </div>\n                    )}\n\n                    <div className=\"mb-3\">\n                      <div className=\"text-xs text-gray-600 mb-1\">Subject:</div>\n                      <div className=\"font-semibold text-sm bg-gray-50 p-2 rounded\">\n                        {generatePreview(formData, 'subject')}\n                      </div>\n                    </div>\n\n                    <div>\n                      <div className=\"text-xs text-gray-600 mb-1\">Content:</div>\n                      <div className=\"text-sm bg-gray-50 p-3 rounded\">\n                        {formData.isHtml ? (\n                          <div\n                            dangerouslySetInnerHTML={{\n                              __html: generatePreview(formData, 'content'),\n                            }}\n                          />\n                        ) : (\n                          <div className=\"whitespace-pre-wrap\">\n                            {generatePreview(formData, 'content')}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex items-center\">\n              <input\n                type=\"checkbox\"\n                id=\"isActive\"\n                checked={formData.isActive}\n                onChange={e =>\n                  setFormData(prev => ({ ...prev, isActive: e.target.checked }))\n                }\n                className=\"mr-2\"\n              />\n              <label htmlFor=\"isActive\" className=\"text-sm font-medium\">\n                Active Template\n              </label>\n            </div>\n\n            <div className=\"flex gap-4\">\n              <Button\n                type=\"submit\"\n                disabled={\n                  addTemplateMutation.isPending ||\n                  updateTemplateMutation.isPending\n                }\n                className=\"bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700\"\n              >\n                {editingId ? 'Update' : 'Add'} Template\n              </Button>\n              <Button\n                type=\"button\"\n                onClick={resetForm}\n                className=\"bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600\"\n              >\n                Cancel\n              </Button>\n            </div>\n          </form>\n        </div>\n\n        {/* Templates List */}\n        {isLoading ? (\n          <div className=\"text-center py-4\">Loading...</div>\n        ) : (\n          <div className=\"space-y-4\">\n            {Array.isArray(templates) &&\n              templates.map(template => (\n                <div key={template.id} className=\"border rounded-lg p-4\">\n                  <div className=\"flex justify-between items-start mb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"text-lg font-semibold\">{template.name}</h3>\n                      <span className=\"bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\">\n                        {template.category}\n                      </span>\n                      {template.isHtml && (\n                        <span className=\"bg-green-100 text-green-800 px-2 py-1 rounded text-xs\">\n                          HTML\n                        </span>\n                      )}\n                      {!template.isActive && (\n                        <span className=\"bg-red-100 text-red-800 px-2 py-1 rounded text-xs\">\n                          Inactive\n                        </span>\n                      )}\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        onClick={() => handleEdit(template)}\n                        className=\"bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600\"\n                      >\n                        Edit\n                      </Button>\n                      <Button\n                        onClick={() => handleDelete(template.id)}\n                        className=\"bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600\"\n                      >\n                        Delete\n                      </Button>\n                    </div>\n                  </div>\n\n                  <div className=\"mb-2\">\n                    <div className=\"text-xs text-gray-600 mb-1\">Subject:</div>\n                    <div className=\"bg-gray-50 p-2 rounded text-sm font-medium\">\n                      {template.subject}\n                    </div>\n                  </div>\n\n                  <div className=\"bg-gray-50 p-3 rounded mb-2\">\n                    <div className=\"text-xs text-gray-600 mb-1\">\n                      Content Preview:\n                    </div>\n                    <div className=\"text-sm max-h-32 overflow-y-auto\">\n                      {template.isHtml ? (\n                        <div\n                          dangerouslySetInnerHTML={{\n                            __html: template.content.substring(0, 200) + '...',\n                          }}\n                        />\n                      ) : (\n                        <div className=\"whitespace-pre-wrap\">\n                          {template.content.substring(0, 200)}...\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {template.variables && template.variables.length > 0 && (\n                    <div className=\"flex flex-wrap gap-1 mb-2\">\n                      <span className=\"text-xs text-gray-600\">Variables:</span>\n                      {Array.isArray(template.variables) &&\n                        template.variables.map((variable, index) => (\n                          <span\n                            key={index}\n                            className=\"bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs font-mono\"\n                          >\n                            {`{${variable}}`}\n                          </span>\n                        ))}\n                    </div>\n\n                )}\n\n                  <div className=\"text-xs text-gray-500\">\n                    Created: {template.createdAt} | Used:{' '}\n                    {template.usageCount || 0} times\n                  </div>\n                </div>\n              ))}\n          </div>\n        )}\n\n        {templates.length === 0 && !isLoading && (\n          <div className=\"text-center py-8 text-gray-500\">\n            No email templates found. Create one to get started.\n          </div>\n        )}\n      </div>\n    </div>\n  )\n};\n\nexport default TemplateEmail"
        }
    ]
}